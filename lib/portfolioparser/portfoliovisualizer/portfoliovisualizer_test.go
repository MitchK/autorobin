package portfoliovisualizer_test

import (
	"strings"
	"testing"

	"github.com/MitchK/autorobin/lib/model"
	"github.com/MitchK/autorobin/lib/portfolioparser/portfoliovisualizer"
	"github.com/onsi/gomega"
)

func TestParse(t *testing.T) {
	g := gomega.NewGomegaWithT(t)

	var portfolio model.Portfolio
	err := portfoliovisualizer.NewParser().Parse(strings.NewReader(examplePVCSVStrFixture()), &portfolio)
	g.Expect(err).To(gomega.BeNil())
	g.Expect(len(portfolio.Weights)).To(gomega.Equal(4))
	g.Expect(len(portfolio.Assets)).To(gomega.Equal(4))

	g.Expect(portfolio.Weights[model.Asset{Symbol: "TRQ"}]).To(gomega.BeNumerically("~", 0.3890))
	g.Expect(portfolio.Weights[model.Asset{Symbol: "LRAD"}]).To(gomega.BeNumerically("~", 0.3603))
	g.Expect(portfolio.Weights[model.Asset{Symbol: "ISIG"}]).To(gomega.BeNumerically("~", 0.1626))
	g.Expect(portfolio.Weights[model.Asset{Symbol: "CELH"}]).To(gomega.BeNumerically("~", 0.0880))

}

func examplePVCSVStrFixture() string {
	return `
"Start Date","01/01/2017"
"End Date","10/31/2018"
"Initial Balance","$10,000"
"Optimization Goal","Minimize Variance"
"Rebalancing","Rebalance monthly"

"Minimum Variance"

"Ticker","Name","Allocation","Min. Weight","Max. Weight"
"TRQ","Turquoise Hill Resources Ltd.","38.90%","0.00%","100.00%"
"LRAD","LRAD Corporation","36.03%","0.00%","100.00%"
"ISIG","Insignia Systems, Inc.","16.26%","0.00%","100.00%"
"CELH","Celsius Holdings","8.80%","0.00%","100.00%"

"Portfolio Performance"

"Metric","Minimum Variance"
"Start Balance","$10,000"
"End Balance","$11,071"
"CAGR","5.71%"
"Expected Return","7.70%"
"Stdev","19.82%"
"Best Year","25.33%"
"Worst Year","-11.67%"
"Max. Drawdown","-15.98%"
"Sharpe Ratio (ex-ante)","0.33"
"Sharpe Ratio (ex-post)","0.32"
"Sortino Ratio","0.48"
"US Stock Market Correlation","0.25"

"Risk and Return Metrics"

"Metric","Minimum Variance"
"Arithmetic Mean (monthly)","0.62%"
"Arithmetic Mean (annualized)","7.70%"
"Geometric Mean (monthly)","0.46%"
"Geometric Mean (annualized)","5.71%"
"Volatility (monthly)","5.72%"
"Volatility (annualized)","19.82%"
"Downside Deviation (monthly)","3.73%"
"Max. Drawdown","-15.98%"
"US Market Correlation","0.25"
"Beta (*)","0.52"
"Alpha (annualized)","1.12%"
"R Squared","6.07%"
"Sharpe Ratio","0.32"
"Sortino Ratio","0.48"
"Treynor Ratio (%)","12.05"
"Information Ratio","-0.24"
"Diversification Ratio","2.03"
"Skewness","-0.23"
"Excess Kurtosis","-0.86"
"Historical Value-at-Risk (5%)","-9.68%"
"Analytical Value-at-Risk (5%)","-8.57%"
"Conditional Value-at-Risk (5%)","-9.80%"
"Upside Capture Ratio (%)","57.50"
"Downside Capture Ratio (%)","79.92"
"Positive Periods","13 out of 22 (59.09%)"
"Gain/Loss Ratio","0.91"
"(*) US Stock Market is used as the benchmark for calculations. Value-at-risk metrics are based on monthly values."

"Annual Returns"

"Year","Inflation","Minimum Variance Return","Minimum Variance Balance","Turquoise Hill Resources Ltd. (TRQ)","LRAD Corporation (LRAD)","Insignia Systems, Inc. (ISIG)","Celsius Holdings (CELH)"
"2017","2.11%","25.33%","$12,533","6.19%","45.61%","-31.94%","114.29%"
"2018","2.58%","-11.67%","$11,071","-50.15%","18.47%","44.54%","-24.00%"
"Annual returns for 2018 are based on partial year data"

"Monthly Returns"

"Year","Month","Minimum Variance Return","Minimum Variance Balance","Turquoise Hill Resources Ltd. (TRQ)","LRAD Corporation (LRAD)","Insignia Systems, Inc. (ISIG)","Celsius Holdings (CELH)"
"2017","1","1.74%","$10,174","11.76%","-13.45%","-11.92%","44.90%"
"2017","2","-3.03%","$9,867","-12.19%","7.43%","-7.14%","2.25%"
"2017","3","-1.70%","$9,698","-3.15%","-5.03%","4.20%","7.44%"
"2017","4","-5.24%","$9,191","-11.07%","5.30%","-17.45%","0.00%"
"2017","5","-0.90%","$9,108","-4.76%","8.18%","-14.63%","4.36%"
"2017","6","0.25%","$9,131","1.92%","-1.16%","-2.86%","4.42%"
"2017","7","6.43%","$9,718","24.15%","-5.88%","-0.98%","-7.76%"
"2017","8","6.62%","$10,361","2.43%","6.87%","6.93%","23.47%"
"2017","9","7.68%","$11,157","-8.01%","24.56%","0.00%","22.11%"
"2017","10","1.20%","$11,291","-0.97%","0.47%","14.81%","-11.34%"
"2017","11","1.33%","$11,441","-3.91%","0.00%","21.77%","-7.82%"
"2017","12","9.54%","$12,533","16.27%","16.36%","-21.19%","8.70%"
"2018","1","-1.82%","$12,306","-11.66%","0.80%","10.92%","7.43%"
"2018","2","-5.19%","$11,667","0.00%","-10.36%","-6.06%","-5.32%"
"2018","3","4.14%","$12,150","1.32%","2.22%","27.42%","-18.54%"
"2018","4","7.23%","$13,029","-3.26%","1.74%","36.71%","21.61%"
"2018","5","-9.80%","$11,752","-6.40%","-10.26%","-15.28%","-12.85%"
"2018","6","8.14%","$12,708","2.16%","25.24%","-10.93%","-0.22%"
"2018","7","0.18%","$12,731","-2.46%","3.80%","2.45%","-7.17%"
"2018","8","3.50%","$13,176","-15.88%","11.36%","30.54%","7.03%"
"2018","9","-7.67%","$12,166","-9.01%","0.66%","-20.64%","-11.82%"
"2018","10","-9.00%","$11,071","-19.34%","-3.59%","-0.58%","-0.99%"

"Drawdowns for Minimum Variance"

"Rank","Start","End","Length","Recovery By","Recovery Time","Underwater Period","Drawdown"
"1","Sep 2018","Oct 2018","2 months","","","","-15.98%"
"2","Feb 2017","May 2017","4 months","Aug 2017","3 months","7 months","-10.48%"
"3","May 2018","May 2018","1 month","Aug 2018","3 months","4 months","-9.80%"
"4","Jan 2018","Feb 2018","2 months","Apr 2018","2 months","4 months","-6.91%"

"Efficient Frontier Assets"

"#","Asset","CAGR","Expected Return (*)","Standard Deviation","Sharpe Ratio (*)","Min. Weight","Max. Weight"
"1","Turquoise Hill Resources Ltd. (TRQ)","-29.31%","-24.98%","35.17%","-0.744","0.00%","100.00%"
"2","LRAD Corporation (LRAD)","34.64%","42.01%","34.90%","1.170","0.00%","100.00%"
"3","Insignia Systems, Inc. (ISIG)","-0.89%","15.20%","57.92%","0.242","0.00%","100.00%"
"4","Celsius Holdings (CELH)","30.48%","45.52%","51.04%","0.869","0.00%","100.00%"
"(*) Expected return is annualized from historical monthly mean return. Ex ante Sharpe Ratio calculated using historical 1-month treasury bill returns as the risk-free rate (1.19% annualized)."

"Efficient Frontier Points"

"#","TRQ","LRAD","ISIG","CELH","Expected Return (*)","Standard Deviation (*)","Sharpe Ratio (*)"
"1","100.00%","0.00%","0.00%","0.00%","-24.98%","35.17%","-0.744"
"2","98.42%","0.00%","1.58%","0.00%","-24.46%","34.47%","-0.744"
"3","96.85%","0.00%","3.15%","0.00%","-23.94%","33.79%","-0.744"
"4","95.27%","0.00%","4.73%","0.00%","-23.42%","33.13%","-0.743"
"5","93.70%","0.00%","6.30%","0.00%","-22.89%","32.51%","-0.741"
"6","92.12%","0.00%","7.88%","0.00%","-22.36%","31.91%","-0.738"
"7","90.54%","0.00%","9.46%","0.00%","-21.82%","31.35%","-0.734"
"8","88.97%","0.00%","11.03%","0.00%","-21.29%","30.81%","-0.729"
"9","87.39%","0.00%","12.61%","0.00%","-20.74%","30.31%","-0.724"
"10","85.82%","0.00%","14.18%","0.00%","-20.20%","29.85%","-0.717"
"11","84.24%","0.00%","15.76%","0.00%","-19.65%","29.42%","-0.708"
"12","83.04%","0.75%","16.21%","0.00%","-19.10%","29.03%","-0.699"
"13","81.98%","1.78%","16.24%","0.00%","-18.55%","28.64%","-0.689"
"14","80.92%","2.81%","16.27%","0.00%","-17.99%","28.25%","-0.679"
"15","79.86%","3.84%","16.30%","0.00%","-17.43%","27.87%","-0.668"
"16","78.80%","4.87%","16.33%","0.00%","-16.86%","27.50%","-0.656"
"17","77.74%","5.90%","16.36%","0.00%","-16.29%","27.13%","-0.644"
"18","76.68%","6.93%","16.39%","0.00%","-15.72%","26.77%","-0.632"
"19","75.62%","7.96%","16.42%","0.00%","-15.14%","26.42%","-0.618"
"20","74.56%","8.99%","16.45%","0.00%","-14.56%","26.07%","-0.604"
"21","73.50%","10.01%","16.48%","0.00%","-13.98%","25.73%","-0.590"
"22","72.44%","11.04%","16.52%","0.00%","-13.39%","25.40%","-0.574"
"23","71.38%","12.07%","16.55%","0.00%","-12.80%","25.07%","-0.558"
"24","70.32%","13.10%","16.58%","0.00%","-12.21%","24.75%","-0.541"
"25","69.26%","14.13%","16.61%","0.00%","-11.61%","24.44%","-0.524"
"26","68.20%","15.16%","16.64%","0.00%","-11.01%","24.14%","-0.505"
"27","67.14%","16.19%","16.67%","0.00%","-10.40%","23.85%","-0.486"
"28","66.08%","17.22%","16.70%","0.00%","-9.79%","23.57%","-0.466"
"29","65.02%","18.25%","16.73%","0.00%","-9.18%","23.30%","-0.445"
"30","63.96%","19.28%","16.76%","0.00%","-8.56%","23.03%","-0.423"
"31","62.90%","20.31%","16.79%","0.00%","-7.94%","22.78%","-0.401"
"32","61.84%","21.34%","16.82%","0.00%","-7.32%","22.54%","-0.377"
"33","60.78%","22.37%","16.85%","0.00%","-6.69%","22.30%","-0.353"
"34","59.72%","23.40%","16.88%","0.00%","-6.06%","22.08%","-0.328"
"35","58.66%","24.43%","16.91%","0.00%","-5.42%","21.87%","-0.302"
"36","57.63%","25.08%","16.89%","0.40%","-4.78%","21.68%","-0.275"
"37","56.61%","25.67%","16.85%","0.86%","-4.13%","21.49%","-0.248"
"38","55.59%","26.27%","16.82%","1.32%","-3.49%","21.31%","-0.219"
"39","54.57%","26.87%","16.78%","1.78%","-2.83%","21.14%","-0.190"
"40","53.55%","27.46%","16.75%","2.23%","-2.18%","20.97%","-0.161"
"41","52.53%","28.06%","16.72%","2.69%","-1.52%","20.82%","-0.130"
"42","51.51%","28.66%","16.68%","3.15%","-0.85%","20.68%","-0.099"
"43","50.49%","29.25%","16.65%","3.61%","-0.18%","20.55%","-0.067"
"44","49.47%","29.85%","16.61%","4.06%","0.49%","20.43%","-0.034"
"45","48.45%","30.45%","16.58%","4.52%","1.17%","20.32%","-0.001"
"46","47.43%","31.05%","16.54%","4.98%","1.85%","20.22%","0.033"
"47","46.41%","31.64%","16.51%","5.44%","2.53%","20.13%","0.067"
"48","45.39%","32.24%","16.48%","5.90%","3.22%","20.05%","0.101"
"49","44.37%","32.84%","16.44%","6.35%","3.92%","19.98%","0.136"
"50","43.35%","33.43%","16.41%","6.81%","4.61%","19.93%","0.172"
"51","42.33%","34.03%","16.37%","7.27%","5.32%","19.88%","0.208"
"52","41.31%","34.63%","16.34%","7.73%","6.02%","19.85%","0.243"
"53","40.29%","35.23%","16.30%","8.18%","6.73%","19.83%","0.280"
"54","39.27%","35.82%","16.27%","8.64%","7.45%","19.82%","0.316"
"55","38.25%","36.42%","16.24%","9.10%","8.17%","19.82%","0.352"
"56","37.23%","37.02%","16.20%","9.56%","8.89%","19.83%","0.388"
"57","36.21%","37.61%","16.17%","10.01%","9.62%","19.86%","0.425"
"58","35.18%","38.21%","16.13%","10.47%","10.36%","19.89%","0.461"
"59","34.16%","38.81%","16.10%","10.93%","11.09%","19.94%","0.497"
"60","33.14%","39.41%","16.06%","11.39%","11.83%","20.00%","0.532"
"61","32.12%","40.00%","16.03%","11.84%","12.58%","20.07%","0.568"
"62","31.10%","40.60%","15.99%","12.30%","13.33%","20.15%","0.603"
"63","30.08%","41.20%","15.96%","12.76%","14.09%","20.24%","0.637"
"64","29.06%","41.79%","15.93%","13.22%","14.85%","20.35%","0.671"
"65","28.04%","42.39%","15.89%","13.68%","15.61%","20.46%","0.705"
"66","27.02%","42.99%","15.86%","14.13%","16.38%","20.59%","0.738"
"67","26.00%","43.58%","15.82%","14.59%","17.16%","20.72%","0.771"
"68","24.98%","44.18%","15.79%","15.05%","17.94%","20.87%","0.803"
"69","23.96%","44.78%","15.75%","15.51%","18.72%","21.02%","0.834"
"70","22.94%","45.38%","15.72%","15.96%","19.51%","21.18%","0.865"
"71","21.92%","45.97%","15.69%","16.42%","20.30%","21.36%","0.895"
"72","20.90%","46.57%","15.65%","16.88%","21.10%","21.54%","0.924"
"73","19.88%","47.17%","15.62%","17.34%","21.90%","21.73%","0.953"
"74","18.86%","47.76%","15.58%","17.79%","22.71%","21.93%","0.981"
"75","17.84%","48.36%","15.55%","18.25%","23.53%","22.14%","1.009"
"76","16.82%","48.96%","15.51%","18.71%","24.34%","22.36%","1.035"
"77","15.80%","49.56%","15.48%","19.17%","25.17%","22.59%","1.062"
"78","14.78%","50.15%","15.45%","19.62%","25.99%","22.82%","1.087"
"79","13.76%","50.75%","15.41%","20.08%","26.83%","23.06%","1.112"
"80","12.74%","51.35%","15.38%","20.54%","27.66%","23.31%","1.136"
"81","11.72%","51.94%","15.34%","21.00%","28.51%","23.56%","1.159"
"82","10.70%","52.54%","15.31%","21.46%","29.36%","23.83%","1.182"
"83","9.67%","53.14%","15.27%","21.91%","30.21%","24.10%","1.204"
"84","8.65%","53.74%","15.24%","22.37%","31.07%","24.37%","1.226"
"85","7.63%","54.33%","15.21%","22.83%","31.93%","24.65%","1.247"
"86","6.61%","54.93%","15.17%","23.29%","32.80%","24.94%","1.267"
"87","5.59%","55.53%","15.14%","23.74%","33.67%","25.23%","1.287"
"88","4.57%","56.12%","15.10%","24.20%","34.55%","25.53%","1.307"
"89","3.55%","56.72%","15.07%","24.66%","35.44%","25.84%","1.325"
"90","2.53%","57.32%","15.03%","25.12%","36.33%","26.15%","1.344"
"91","1.51%","57.91%","15.00%","25.57%","37.22%","26.46%","1.362"
"92","0.49%","58.51%","14.97%","26.03%","38.12%","26.78%","1.379"
"93","0.00%","59.65%","13.40%","26.95%","39.03%","27.12%","1.395"
"94","0.00%","61.28%","10.41%","28.31%","39.94%","27.59%","1.405"
"95","0.00%","62.91%","7.43%","29.66%","40.86%","28.18%","1.407"
"96","0.00%","64.54%","4.44%","31.01%","41.78%","28.90%","1.404"
"97","0.00%","66.18%","1.46%","32.37%","42.71%","29.74%","1.396"
"98","0.00%","53.32%","0.00%","46.68%","43.64%","31.69%","1.340"
"99","0.00%","26.66%","0.00%","73.34%","44.58%","39.48%","1.099"
"100","0.00%","0.00%","0.00%","100.00%","45.52%","51.04%","0.869"
"(*) Ex-ante values shown for portfolio return and volatility. Ex ante Sharpe Ratio calculated using historical 1-month treasury bill returns as the risk-free rate (1.19% annualized)."

"Portfolio Components"

"Ticker","Name","CAGR","Stdev","Best Year","Worst Year","Max. Drawdown","Sharpe Ratio","Sortino Ratio","US Mkt Correlation"
"TRQ","Turquoise Hill Resources Ltd.","-29.31%","35.17%","6.19%","-50.15%","-52.63%","-0.84","-1.11","0.07"
"LRAD","LRAD Corporation","34.64%","34.90%","45.61%","18.47%","-16.33%","0.99","2.13","0.21"
"ISIG","Insignia Systems, Inc.","-0.89%","57.92%","44.54%","-31.94%","-42.24%","0.23","0.39","0.07"
"CELH","Celsius Holdings","30.48%","51.04%","114.29%","-24.00%","-32.49%","0.72","1.58","0.13"

"Monthly Correlations"

"Ticker","Name","TRQ","LRAD","ISIG","CELH","Minimum Variance"
"TRQ","Turquoise Hill Resources Ltd.","-","-0.12","-0.18","0.14","0.56"
"LRAD","LRAD Corporation","-0.12","-","-0.02","0.10","0.57"
"ISIG","Insignia Systems, Inc.","-0.18","-0.02","-","0.00","0.34"
"CELH","Celsius Holdings","0.14","0.10","0.00","-","0.39"

"Return Decomposition"

"Ticker","Name","Minimum Variance"
"TRQ","Turquoise Hill Resources Ltd.","-$2,703"
"LRAD","LRAD Corporation","$2,587"
"ISIG","Insignia Systems, Inc.","$632"
"CELH","Celsius Holdings","$555"

"Risk Decomposition"

"Ticker","Name","Minimum Variance"
"TRQ","Turquoise Hill Resources Ltd.","38.90%"
"LRAD","LRAD Corporation","36.03%"
"ISIG","Insignia Systems, Inc.","16.26%"
"CELH","Celsius Holdings","8.80%"

"Notes:"
"Past performance is not a guarantee of future returns and data and other errors may exist. See Disclaimer and Terms of Use"
"The year range is automatically adjusted based on the selected year range and available return data for the specified assets"
"The annual results for 2018 are based on full calendar months from January to October"
"See methodology section of the FAQ for more information on portfolio optimization and its limitations."
"CAGR = Compound Annual Growth Rate"
"Stdev = Annualized standard deviation of monthly returns"
"Sharpe ratio is calculated and annualized from monthly excess returns over the risk free rate (1-month treasury bill)"
"Drawdowns are calculated based on monthly returns."
"The backtested results include monthly rebalancing of portfolio assets to match the specified allocation."
"The results use total return and assume that all dividends and distributions are reinvested. Taxes and transaction fees are not included."
`
}
